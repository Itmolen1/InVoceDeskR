
@model InvoiceDiskLast.Models.MvcPurchaseViewModel

@{
    ViewBag.Title = "AddOrEdit";
}

<script src="~/Scripts/jquery-1.10.2.js"></script>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>

<style>
    .pt-3-half {
        padding-top: 1.4rem;
    }
</style>


@{

    var Contectdatas = ViewBag.Contentdata;
    var CompanyDatas = ViewBag.Companydata;


}



<script type="text/javascript">
    var currentRow1 = "";
    var r = "";

    function SUMOFALLPRODUCTp() {
        var sum = 0;
        $('#orderdetailsitemsp tbody tr').each(function () {
            var row = $(this).closest('tr');
            var total = row.find('td:eq(3)').find('.PurchaseTotal').val();
            if (!isNaN(total) && total.length != 0) {
                sum += parseFloat(total);
            }
            $('#TotalBTWp').text(sum.toFixed(2));
            $('#SubTotalp').text(sum.toFixed(2));
        })
    }
    function sumofGrandModelp() {

        var btw6p = 0, btw21p, totalbtwp = 0, grandtotalp = 0;
        btw6p = parseFloat($('#BTW6p').text());
        btw21p = parseFloat($('#BTW21p').text());
        totalbtwp = parseFloat($('#TotalBTWp').text());
        btw6p = isNaN(btw6p) ? 0 : btw6p;
        btw21p = isNaN(btw21p) ? 0 : btw21p;
        totalbtwp = isNaN(totalbtwp) ? 0 : totalbtwp;
        grandtotalp = parseFloat(btw6p) + parseFloat(btw21p) + parseFloat(totalbtwp);
        var t = parseFloat(grandtotalp);
        $('#gtotalp').text(t.toFixed(2));
        //
        //if (!isNaN(grandtotal) && grandtotal.length != 0) {
    }
    function calculatevatp() {
        if ($('#orderdetailsitemsp .tbody tr').length == 0) {
            $('#btwop').text('0.00');
            $('#BTW6p').text('0.00');
            $('#BTW21p').text('0.00');
            $('#gtotalp').val('0.00');

            $('#TotalBTWp').text('0.00');
            $('#TotalBTWp').text('0.00');
            $('#SubTotalp').text('0.00');

        }
        else {

            var sum0 = 0;
            var total0 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                $('#BTW0p').text();

                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp   option:selected').val() == 0) {
                    total0 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total0) && total0.length != 0) {
                        sum0 += parseInt(total0);
                    }
                    var totalvat0 = parseFloat(sum0 / 100 * 6 + sum0 - sum0);
                    var totalr = Math.round(totalvat0, 2);
                    $('#BTW0p').text(totalvat0.toFixed(2));
                }
                else {
                    $('#BTW0p').text('0.00');
                }
            })
        }

        var sum6 = 0;
        var total6 = 0;
        $('#orderdetailsitemsp tbody tr').each(function () {
            var r = $(this).closest('tr');
            var value = r.find('.VATp   option:selected').val();
            if (r.find('.VATp   option:selected').val() == 6) {
                total6 = r.find('td:eq(3)').find('input').val();
                if (!isNaN(total6) && total6.length != 0) {
                    sum6 += parseInt(total6);
                }
                var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                var totalr = Math.round(totalvat6, 2);
                $('#BTW6p').text(totalvat6.toFixed(2));
            }
        })

        var sum21 = 0;
        var total21 = 0;
        $('#orderdetailsitemsp tbody  tr ').each(function () {
            //$('#BTW21').text();
            var r = $(this).closest('tr');
            var value = r.find('.VATp   option:selected').val();
            if (r.find('.VATp   option:selected').val() == 21) {

                total21 = r.find('td:eq(3)').find('input').val();
                if (!isNaN(total21) && total21.length != 0) {
                    sum21 += parseInt(total21);
                }
                var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);

                $('#BTW21p').text(totalvat21.toFixed(2));
            }

        })
        RowCountep();
    }
    function RowCountep() {

        var rowCount6 = 0;
        var rowCount21 = 0;
        var rowCount0 = 0;

        $('#orderdetailsitemsp tbody tr td').each(function () {


            var EquationResult = $(this).find('.VATp').val();

            if (EquationResult == 6) {
                rowCount6++;

            }
            else if (EquationResult == 21) {
                rowCount21++;
            }
            else if (EquationResult == 0) {
                rowCount0++
            }
        })

        if (rowCount0 == 0) {
            $("#btwop").text('0.00');
        }
        if (rowCount6 == 0) {
            $("#BTW6p").text('0.00');
        }
        if (rowCount21 == 0) {
            $("#BTW21p").text('0.00');
        }

        if ($('#orderdetailsitemsp .tbody tr').length == 0) {

            $('#SubTotalp').text('0.00');
            $('#TotalBTWp').text('0.00');
            $('#gtotalp').text('0.00');
            $('#gtotalp').val('0.00');
            $('#btwop').text('0.00');
            $('#BTW6p').text('0.00');
            $('#BTW21p').text('0.00');
            $('#gtotalp').val('0.00');

            $('#TotalBTWp').text('0.00');
            $('#TotalBTWp').text('0.00');
            $('#SubTotalp').text('0.00');
        }
    }


    //adding Row
    $("#addpuchase").click(function () {


        currentRow1 = $(this).closest("tr");

        var isAllValid = true;
        if ($("#mainrow #SelectProductQutationp").val() == "0") {
            isAllValid = false;
            alert("Please select Item");
            return;
        }

        if ($("#mainrow .PurchaseQuantity").val() == 0) {
            isAllValid = false;
            alert("Please select quantity");
        }

        if ($("#mainrow .PurchaseItemRate").val() == 0) {
            isAllValid = false;
            alert("please provide Item rate");
        }


        if (isAllValid) {
            var $newRowp = $("#mainrow").clone().removeAttr('id');
            $('.productp', $newRowp).val($("#SelectProductQutationp").val());
            $('.VATp', $newRowp).val($("#SelectVATp").val());
            //Replace add button with remove button
            $("#addpuchase", $newRowp).addClass('remove').val('Remove').removeClass('btn-success').addClass('btn-danger');
            //Remove id attribute from new clone row
            $("#productp,#PurchaseQuantity,#Ratep,#FTotalp,#SelectVATp", $newRowp).removeAttr('id');
            $('span.error', $newRowp).remove();
            $('#orderdetailsitemsp').append($newRowp);

            $('#mainrow #SelectProductQutationp').not("tbody").val('0');
            $('#mainrow #PurchaseQuantity ').val('');
            $('#mainrow #PurchaseItemRate ').val('');
            $('#mainrow #PurchaseTotal ').val('');
            $('#mainrow #VATp ').val('0');

            if ($('#orderItemError').text != '') {
                $('#orderItemError').text('');
            }
            calculatevatp();
            SUMOFALLPRODUCTp();
            sumofGrandModelp();


            $('#mainrow #SelectVATp').val(0);
        }
    });
    //end of adding row
    $('#orderdetailsitemsp').on('click', '.remove', function () {

       
        var isAllValid = true;
        var currentRow = $(this).closest('tr');
        var vat = currentRow.find('.VATp   option:selected').val();
        var Total = currentRow.find('.PurchaseTotal').val();
        if (vat == 6) {
            var totalvat6 = parseInt(Total / 100) * 6 + (Total - Total);

            var BTW6 = $('#BTW6p').text();
            $('#BTW6p').text();
            $('#BTW6p').text(parseInt(BTW6 - totalvat6.toFixed(2)));

        }
        if (vat == 21) {
            var currentRow = $(this).closest('tr');
            var vat21 = currentRow.find('.VATp  option:selected').val();
            var Total21 = currentRow.find('.PurchaseTotal').val();
            if (vat == 21) {
                var totalvat21 = parseFloat(Total21 / 100) * 21 + (Total21 - Total21);

                var BTW21 = $('#BTW21p').text();
                $('#BTW21p').text();
                $('#BTW21p').text(parseFloat(BTW21 - totalvat21.toFixed(2)));

            }
        }
        $(this).parents('tr').remove();
        SUMOFALLPRODUCTp();
        sumofGrandModelp();

        if ($('#orderdetailsitemsp .tbody tr').length == 0) {
            $('#SubTotalp').text('0.00');
            $('#TotalBTWp').text('0.00');
            $('#gtotalp').text('0.00');
            $('#BTW6p').text('0.00');
            $('#BTW21p').text('0.00');
            $('#btwop').text('0.00');
            $('#SelectVATp').val(0);
        }
    });

    //main
    $('#PurchaseQuantity').keyup(function () {
        var currentRow = $(this).closest("tr");
        var quantity = $(this).val();  // get current row 1st TD value
        var Price = currentRow.find("td:eq(2)").find('input').val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total.toFixed(2));
    })

    $(document).on('keyup', "#orderdetailsitemsp tbody .PurchaseQuantity", function () {
       
        var currentRow = $(this).closest("tr");
        var quantity = $(this).val();  // get current row 1st TD value
        var Price = currentRow.find("td:eq(2)").find('input').val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
    })

    $(document).on('keyup', "#orderdetailsitemsp tbody .PurchaseItemRate", function () {

        currentRow1 = $(this).closest("tr");
        var currentRow = $(this).closest("tr");
        var quantity = currentRow.find("td:eq(1)").find('input').val(); // get current row 1st TD value
        var Price = $(this).val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
        var sum = 0;
        var vatValue = currentRow1.find('.VATp option:selected').val();
        if (vatValue == 0) {
            $('#btwop').text('0.00');
        }

        if (vatValue == 6) {
            var sum6 = 0;
            var total6 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 6) {
                    total6 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total6) && total6.length != 0) {
                        sum6 += parseFloat(total6);
                    }
                    var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                    $('#BTW6p').text(totalvat6.toFixed(2));
                }
            })
        }

        if (vatValue == 21) {
            var sum21 = 0;
            var total21 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 21) {
                    total21 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total21) && total21.length != 0) {
                        sum21 += parseFloat(total21);
                    }
                    var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);
                    $('#BTW21p').text(totalvat21.toFixed(2));
                }

            })
        }
        SUMOFALLPRODUCTp();
        sumofGrandModelp();
    })

    $(document).on('keyup', "#orderdetailsitemsp tbody .PurchaseQuantity ", function () {
        currentRow1 = $(this).closest("tr");
        var currentRow = $(this).closest("tr");
        var quantity = $(this).val();

        // get current row 1st TD value
        var Price = currentRow.find("td:eq(2)").find('input').val();

        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total.toFixed(2));
        var sum = 0;
        var vatValue = currentRow1.find('.VATp option:selected').val();
        if (vatValue == 0) {
            $('#btwop').text('0.00');
        }

        if (vatValue == 6) {
            var sum6 = 0;
            var total6 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 6) {
                    total6 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total6) && total6.length != 0) {
                        sum6 += parseFloat(total6);
                    }
                    var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                    $('#BTW6p').text(totalvat6.toFixed(2));
                }
            })


        }

        if (vatValue == 21) {
            var sum21 = 0;
            var total21 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 21) {
                    total21 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total21) && total21.length != 0) {
                        sum21 += parseFloat(total21);
                    }
                    var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);
                    $('#BTW21p').text(totalvat21.toFixed(2));
                }

            })
        }


        SUMOFALLPRODUCTp();
        sumofGrandModelp();
    })

    $(document).on('change', '#orderdetailsitemsp tbody .VATp', function () {
        currentRow1 = $(this).closest("tr");
        calculatevatp();
        SUMOFALLPRODUCTp();
        sumofGrandModelp();
    });

    $(document).ready(function () {
        localStorage.removeItem("drpstatusvalue");
        LoadProductSelect("Good");

    });


    function LoadProductSelect(pTypeGoodServices)
    {
        LoadProductUnitPurchase();

        $("#mainrow #SelectProductQutationp").find("option").remove();
        $("#mainrow #SelectProductQutationp").prepend("<option value=0>" + 'Select Item' + "</option>");
        $("#mainrow #SelectProductQutationp").append("<option value=AddNewProductSelect>" + 'Add New Product' + "</option>");

        $.ajax({
            url: "/MVCProduct/GetProduct",
            type: "Get",
            async: false,
            data: {ProductStatus: pTypeGoodServices},
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                $.each(data, function (key, item) {
                    $('#mainrow #SelectProductQutationp').append($('<option></option>').val(item.ProductId).html(item.ProductName));
                });
            },
            Error: function (errormessage) {
                alert(errormessage);
            }
        });
    }

    // product price by id
    $('#mainrow .pClassp').change(function () {

        var currentRow=$(this).closest('tr');

        var value = $(this).val();
        if (value == "AddNewProductSelect") {
            //LoadProductUnit();          
            //$('#UpdateProId').hide();          
            //$('select#Type option').each(function () {
            //    if ($(this).text() == "Good") {
            //        this.selected = true;
            //        return;
            //    }
            //});
            //$('#CreateNewProductModal').modal('show');
            ShowServiceGood("Good");
            $('#TypeGoodsServices').attr('disabled', false);
            $('#UpdateProIdGoods').hide();
            $('#SAveProdIDGoods').show();
            $('#TypeGoodsServices').attr('disabled', 'disabled');              
            $('#CreateNewProductModalGoods').modal('show');

        }
        else if (value == "0") {

            return;
        }
        else {

            var productId = $(this).val();
            $.ajax({
                url: "/MVCQutation/ProductPricebyId",
                type: "POST",
                cache: false,
                data: { 'ProductId': productId },
                success: function (resultData) {

                    $('#PurchaseItemRate ').val(resultData);
                    ChangeTotalOnItemCahe(currentRow);
                },
                error: function (errormessage) {
                    // alert(errormessage)
                }
            });
        }
    })

    //end



    function ChangeTotalOnItemCahe(currentRow) {

        var quantity = currentRow.find("td:eq(1)").find('input').val();  // get current row 1st TD value
        var Price = currentRow.find("td:eq(2)").find('input').val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);

    }




    //number validation
    $(".PurchaseQuantity").on("keypress keyup blur", function (event) {
        //this.value = this.value.replace(/[^0-9\.]/g,'');
        $(this).val($(this).val().replace(/[^0-9]/g, ''));
        if ((event.which != 46 || $(this).val().indexOf('.') != -1) && (event.which < 48 || event.which > 57)) {
            event.preventDefault();
        }
    });
    $("#PurchaseItemRate").on("keypress keyup blur", function (event) {
        //this.value = this.value.replace(/[^0-9\.]/g,'');
        $(this).val($(this).val().replace(/[^0-9\.]/g, ''));
        if ((event.which != 46 || $(this).val().indexOf('.') != -1) && (event.which < 48 || event.which > 57)) {
            event.preventDefault();
        }
    });
    //end of number validation


    //saving detail
    $("#Submitp").click(function () {
        var ValidOrNot=validateQutationAddOrEdit();



        if(ValidOrNot!=true){
            return true;
        }
        else{

            var isAllValid = true;
            $('#orderItemError').text('');
            var list = [];
            var errorItemCount = 0;
            $('#orderdetailsitemsp > tbody > tr').not("tr:last").each(function (index, ele) {
                if ($('#SelectProductQutationp', this).val() == '0' ||
                    (parseInt($('.PurchaseQuantity', this).val()) || 0) == 0 ||
                    $('.ratep', this).val() == "" ||
                    isNaN($('.PurchaseItemRate ', this).val())
                    ) {
                    errorItemCount++;
                    $(this).addClass('error');
                }
                else {
                    var orderItem = {
                        PurchaseItemId: $('select.productp', this).val(),
                        PurchaseQuantity: parseInt($('.PurchaseQuantity', this).val()),
                        PurchaseItemRate: parseFloat($('.PurchaseItemRate', this).val()),
                        PurchaseTotal: parseFloat($('.PurchaseTotal', this).val()),
                        Total: parseFloat($('.PurchaseTotal', this).val()),
                        PurchaseVatPercentage: parseFloat($('.VATp', this).val()),
                        PurchaseOrderDetailsId: $('.PurchaseOrderDetailsId', this).val(),
                        PurchaseOrderID: $('.PurchaseOrderID').val(),
                    }
                    list.push(orderItem);
                }
            });

            if (errorItemCount > 0) {
                $("#orderItemError").text(errorItemCount + "Invalid entry in order itme list.");
                isAllValid = false;
            }

            if (list.length == 0) {

                $("#orderItemError").text("At least one order item required.");
                isAllValid = false;
            }

            if (isAllValid) {

                $(this).val("please wait...");
                var empObj = {
                    PurchaseId: $('#PurchaseId').val(),
                    PurchaseID: $('#PurchaseID').val(),
                    PurchaseRefNumber: $('#PurchaseRefNumber').val(),
                    PurchaseDate: $('#PurchaseDate').val(),
                    PurchaseDueDate: $('#PurchaseDueDate').val(),
                    PurchaseSubTotal: $('#SubTotalp').text(),
                    PurchaseDiscountAmount: $('#PurchaseDiscountAmount').val(),
                    PurchaseOrderID: $('#PurchaseOrderID').val(),
                    PurchaseTotoalAmount: $('#gtotalp').text(),
                    PurchaseVenderNote: $('#PurchaseVenderNote').val(),
                    Vat6: $('#BTW6p').text(),
                    Vat21: $('#BTW21p').text(),
                    Purchase_ID: $('.Purchase_ID').val(),
                    PurchaseDetailslist: list
                };
                $.ajax({
                    url: "/Purchase/save",
                    data: JSON.stringify(empObj),
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {

                        if (result.Status == "Success") {
                            list = [];
                            $('#orderdetailsitems').empty();
                            $("#Submit").val('Save');
                            swal({
                                title: 'Invoice!',
                                text: 'Invoice save successfully!',
                                type: 'success'
                            },
                      function (isconform) {
                          window.location.href = "/Purchase/Viewinvoice?purchaseOrderId=" + result.purchaseId;
                      });
                        }
                        else if (result.Status == "Fail") {
                            swal({
                                title: "Fail!",
                                text: result.Message,
                                icon: "danger",
                            });

                        }
                    },
                    error: function (errormessage) {
                        swal({
                            title: "Fail!",
                            text: errormessage,
                            icon: "danger",
                        });
                    }

                });

            }
        }

    });
    //saveing detail

    //Save Email
    $("#saveEmailp").click(function () {


        var ValidOrNot=validateQutationAddOrEdit();

        if(ValidOrNot!=true){
            return true;
        }
        else{


            var isAllValid = true;
            $('#orderItemError').text('');

            var list = [];
            var errorItemCount = 0;

            $('#orderdetailsitemsp > tbody > tr ').not("tr:last").each(function (index, ele) {

                if ($('#SelectProductQutationp', this).val() == '0' ||
                    (parseInt($('.PurchaseQuantity', this).val()) || 0) == 0 ||
                    $('.ratep', this).val() == "" ||
                    isNaN($('.PurchaseItemRate ', this).val())
                    ) {
                    errorItemCount++;
                    $(this).addClass('error');
                }
                else {
                    var orderItem = {
                        PurchaseItemId: $('select.productp', this).val(),
                        PurchaseQuantity: parseInt($('.PurchaseQuantity', this).val()),
                        PurchaseItemRate: parseFloat($('.PurchaseItemRate', this).val()),
                        PurchaseTotal: parseFloat($('.PurchaseTotal', this).val()),
                        Total: parseFloat($('.PurchaseTotal', this).val()),
                        PurchaseVatPercentage: parseFloat($('.VATp', this).val()),
                        PurchaseOrderDetailsId: $('.PurchaseOrderDetailsId', this).val(),
                        PurchaseOrderID: $('.PurchaseOrderID').val(),
                    }
                    list.push(orderItem);
                }
            });

            if (errorItemCount > 0) {
                $("#orderItemError").text(errorItemCount + "Invalid entry in order itme list.");
                isAllValid = false;
            }

            if (list.length == 0) {

                $("#orderItemError").text("At least one order item required.");
                isAllValid = false;
            }

            if (isAllValid) {

                $(this).val("please wait...");
                var empObj = {
                    PurchaseId: $('#PurchaseId').val(),
                    PurchaseID: $('#PurchaseID').val(),
                    PurchaseRefNumber: $('#PurchaseRefNumber').val(),
                    PurchaseDate: $('#PurchaseDate').val(),
                    PurchaseDueDate: $('#PurchaseDueDate').val(),
                    PurchaseSubTotal: $('#SubTotalp').text(),
                    PurchaseDiscountAmount: $('#PurchaseDiscountAmount').val(),
                    PurchaseOrderID: $('#PurchaseOrderID').val(),
                    PurchaseTotoalAmount: $('#gtotalp').text(),
                    PurchaseVenderNote: $('#PurchaseVenderNote').val(),
                    Vat6: $('#BTW6p').text(),
                    Vat21: $('#BTW21p').text(),
                    Purchase_ID: $('.Purchase_ID').val(),

                    PurchaseDetailslist: list

                };
                $.ajax({
                    url: "/Purchase/saveEmail",
                    data: JSON.stringify(empObj),
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {

                        if (result.Status == "Success") {

                            swal({
                                title: 'Invoice!',
                                text: 'Invoice save successfully!',
                                type: 'success'
                            },
                            function (isconform) {
                                window.location.href = "/Purchase/InvoiceByEmail?purchaseOrderId=" + result.PurchaseOrderId;
                            });
                            $("#saveEmailp").val('Save + Email');
                            list = [];

                        }
                        else if (result.Status == "Fail") {
                            swal({
                                title: "Fail!",
                                text: result.Message,
                                icon: "danger",
                            });
                        }
                    },
                    error: function (errormessage) {
                        swal({
                            title: "Fail!",
                            text: errormessage,
                            icon: "danger",
                        });
                    }

                });

            }
        }
    });

    //End save and Email

    //save print
    $("#SaveEmailPrintPrintp").click(function () {


        var ValidOrNot=validateQutationAddOrEdit();

        if(ValidOrNot!=true){
            return true;
        }
        else{


            var isAllValid = true;
            $('#orderItemError').text('');

            var list = [];
            var errorItemCount = 0;

            $('#orderdetailsitemsp > tbody > tr ').not("tr:last").each(function (index, ele) {

                if ($('#SelectProductQutationp', this).val() == '0' ||
                    (parseInt($('.PurchaseQuantity', this).val()) || 0) == 0 ||
                    $('.ratep', this).val() == "" ||
                    isNaN($('.PurchaseItemRate ', this).val())
                    ) {
                    errorItemCount++;
                    $(this).addClass('error');
                }
                else {
                    var orderItem = {
                        PurchaseItemId: $('select.productp', this).val(),
                        PurchaseQuantity: parseInt($('.PurchaseQuantity', this).val()),
                        PurchaseItemRate: parseFloat($('.PurchaseItemRate', this).val()),
                        PurchaseTotal: parseFloat($('.PurchaseTotal', this).val()),
                        Total: parseFloat($('.PurchaseTotal', this).val()),
                        PurchaseVatPercentage: parseFloat($('.VATp', this).val()),
                        PurchaseOrderDetailsId: $('.PurchaseOrderDetailsId', this).val(),
                        PurchaseOrderID: $('.PurchaseOrderID').val(),
                    }
                    list.push(orderItem);
                }
            });

            if (errorItemCount > 0) {
                $("#orderItemError").text(errorItemCount + "Invalid entry in order itme list.");
                isAllValid = false;
            }

            if (list.length == 0) {

                $("#orderItemError").text("At least one order item required.");
                isAllValid = false;
            }

            if (isAllValid) {

                $(this).val("please wait...");
                var empObj = {
                    PurchaseId: $('#PurchaseId').val(),
                    PurchaseID: $('#PurchaseID').val(),
                    PurchaseRefNumber: $('#PurchaseRefNumber').val(),
                    PurchaseDate: $('#PurchaseDate').val(),
                    PurchaseDueDate: $('#PurchaseDueDate').val(),
                    PurchaseSubTotal: $('#SubTotalp').text(),
                    PurchaseDiscountAmount: $('#PurchaseDiscountAmount').val(),
                    PurchaseOrderID: $('#PurchaseOrderID').val(),
                    PurchaseTotoalAmount: $('#gtotalp').text(),
                    PurchaseVenderNote: $('#PurchaseVenderNote').val(),
                    Vat6: $('#BTW6p').text(),
                    Vat21: $('#BTW21p').text(),
                    Purchase_ID: $('.Purchase_ID').val(),
                    PurchaseDetailslist: list
                };
                $.ajax({
                    url: "/Purchase/savePrintAndSentItToYouronsave",
                    data: JSON.stringify(empObj),
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {
                        localStorage.setItem('path1', result.path);

                        if (result.Status == "Success") {

                            swal({
                                title: 'Invoice!',
                                text: 'Invoice save successfully!',
                                type: 'success'
                            },
                            function (isconform) {
                                window.location.href = "/Purchase/Viewinvoice?purchaseOrderId=" + result.PurchaseOrderId;
                            });
                        }
                        else if (result.Status == "Fail") {
                            $("#SaveEmailPrintPrintp").val("Save + print and send and send ot yourself");


                            swal({
                                title: "Fail!",
                                text: result.Message,
                                icon: "danger",
                            });
                        }
                    },
                    error: function (errormessage) {
                        $("#SaveEmailPrintPrintp").val("Save + print and send and send ot yourself");
                        swal({
                            title: "Fail!",
                            text: errormessage,
                            icon: "danger",
                        });
                    }
                });
            }
        }
    });



    $(document).ready(function () {

        $(document).on('click', '#RemoveEdit1', function () {


            var row = $(this).closest('tr');

            var PurchaseOrderId = $('#PurchaseOrderID').val();
            var purchaseTotal = row.find('td').find('.PurchaseTotal').val();
            var vat = row.find('td').find('#SelectVATp').val();
            var PurchaseOrderDetailId = row.find('td').find('.PurchaseOrderDetailsId').val();

            var purchase = JSON.stringify({
                PurchaseOrderId: PurchaseOrderId,
                purchaseOrderDetailId: PurchaseOrderDetailId,
                vat: vat,
                total: purchaseTotal
            })
            $.ajax({
                url: "/Purchase/DeleteInvoice",
                type: "POST",
                async: false,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: purchase,
                success: function (data) {
                    if (data.Status == "Success") {
                        $("#" + PurchaseOrderDetailId).remove();
                        calculatevatp();
                        SUMOFALLPRODUCTp();
                        SUMOFALLPRODUCTp();
                        swal({
                            title: 'Invoice!',
                            text: 'Invoice save successfully!',
                            type: 'success'
                        });

                    }
                    else if (data.Status == "Fail") {

                        swal({
                            title: 'Invoice!',
                            text: 'fail to remove Invoice!',
                            type: 'danger'
                        });
                    }
                },
                Error: function (errormessage) {
                    swal({
                        title: "Fail!",
                        text: errormessage,
                        icon: "danger",
                    });

                }

            });
        });
    });





    function validateQutationAddOrEdit() {
        var isValid = true;

        if ($('#PurchaseID').val().trim() == "") {
            $('#PurchaseID').css('border-color', 'Red');

            isValid = false;
        }
        else {
            $('#PurchaseID').css('border-color', 'lightgrey');
        }
        if ($('#PurchaseDueDate').val().trim() == "") {
            $('#PurchaseDueDate').css('border-color', 'Red');
            isValid = false;
        }
        else {
            $('#PurchaseDueDate').css('border-color', 'lightgrey');
        }
        if ($('#PurchaseRefNumber').val().trim() == "") {
            $('#PurchaseRefNumber').css('border-color', 'Red');
            $('#PurchaseRefNumber').focus();
            isValid = false;
        }
        else {
            $('#PurchaseRefNumber').css('border-color', 'lightgrey');
        }
        if ($('#PurchaseDate').val() == "") {
            $('#PurchaseDate').css('border-color', 'Red');
            isValid = false;
        }
        else {
            $('#PurchaseDate').css('border-color', 'lightgrey');
        }
        return isValid;
    }


    function LoadProductAdding1() {

        $("#SelectProductQutationp").find("option").remove();
        $("#SelectProductQutationp").prepend("<option value=0>" + 'Select Item' + "</option>");
        $("#SelectProductQutationp").append("<option value=AddNewProductSelect>" + 'Add New Product' + "</option>");

        $.ajax({
            url: "/MVCProduct/GetProduct",
            type: "Get",
            async: false,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {

                $.each(data, function (key, item) {

                    $('#SelectProductQutationp').append($('<option></option>').val(item.ProductId).html(item.ProductName));

                });

            },
            Error: function (errormessage) {
                alert(errormessage);
            }

        });
    }


    $('#ProductUnitSelectPurchase').change(function () {

        var value = $(this).val();
        if (value == "AddNewPUnitSelect") {

            $('#CreateNewProductModal').modal('hide');
            $('#UnitModel').modal('show');
        }

    });

    function LoadProductUnitPurchase() {

        $("#ProductUnitSelectPurchase").find("option").remove();

        $("#ProductUnitSelectPurchase").prepend("<option value=0>" + 'Select Unit' + "</option>");
        $("#ProductUnitSelectPurchase").append("<option value=AddNewPUnitSelect>" + 'Add New Unit' + "</option>");

        $.ajax({
            url: "/MVCProductUnit/GetProductUnit",
            type: "Get",
            async: false,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {

                $.each(data, function (key, item) {
                    $('#ProductUnitSelectPurchase').append($('<option></option>').val(item.ProductUnitID).html(item.ProductUnit));
                });

            },
            Error: function (errormessage) {
                alert(errormessage);
            }

        });
    }-


    $(document).ready(function () {

        var PurchaseDate=@Html.Raw(Json.Encode(Model.PurchaseDate));
        var PurchaseDueDate=@Html.Raw(Json.Encode(Model.PurchaseDueDate));



    });



</script>
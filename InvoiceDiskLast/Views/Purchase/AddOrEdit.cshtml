
@model InvoiceDiskLast.Models.MvcPurchaseViewModel

@{
    ViewBag.Title = "AddOrEdit";
}

<script src="~/Scripts/jquery-1.10.2.js"></script>
<script src="~/Scripts/jquery-1.10.2.min.js"></script>

<style>
    .pt-3-half {
        padding-top: 1.4rem;
    }
</style>


@{

    var Contectdatas = ViewBag.Contentdata;
    var CompanyDatas = ViewBag.Companydata;


}

<div class="container">

    @*<input type="hidden"  value=" " id="PurchaseOrderID"/>*@
    <input type="hidden" value="@(Model.PurchaseOrderID !=null?Model.PurchaseOrderID:0)" id="PurchaseOrderID" />

    <input type="hidden" value="@Contectdatas.ContactsId" id="contactId" />
    <div class="row">

        <div class="col-sm-12" style="background-color:white;margin-top:50px">
            <div class="row">
                <div class="col-sm-1"></div>
                <div class="col-sm-11" style="margin-top:20px">
                    <img src="@Url.Content("~/Images/"+CompanyDatas.CompanyLogo)" class="img-responsive" id="targetImg" style="height:100px; width:100px;border:none" />
                </div>
            </div>

            <div class="row">
                <div class="col-sm-1"></div>
                <div class="col-sm-3">
                    <h5>@CompanyDatas.CompanyName</h5>
                    <h5>@CompanyDatas.CompanyAddress</h5>
                    <h5>@CompanyDatas.CompanyPhone</h5>
                    <h5>@CompanyDatas.CompanyEmail</h5>
                </div>
                <div class="col-sm-4"></div>
                <div class="col-sm-4" style="margin-top:10px">
                    <h5>@Contectdatas.ContactName</h5>
                    <h5>@Contectdatas.ContactAddress</h5>
                    <h5>@Contectdatas.BillingEmail</h5>
                    <h5>@Contectdatas.BillingVatTRN</h5>
                </div>
            </div>


            <div class="row">
                <div class="col-sm-1"></div>
                <div class="col-sm-11">
                    <h4 style="color:skyblue">Invoice</h4>
                    <div class="form-horizontal">
                        <div class="row">
                            <div class="col-sm-2">Invoice Date:</div>
                            <div class="col-sm-4">
                                @Html.EditorFor(model => model.PurchaseDate, new { htmlAttributes = new { @class = "form-control", id = "PurchaseDate" } })
                                @Html.ValidationMessageFor(model => model.PurchaseDate, "", new { @class = "text-danger" })

                            </div>
                            <div class="col-sm-6"></div>
                        </div>

                        <div class="row" style="margin-top:3px">
                            <div class="col-sm-2">Invoice Number:</div>
                            <div class="col-sm-4">

                                @Html.EditorFor(model => model.Purchase_ID, new { htmlAttributes = new { @class = "form-control", id = "PurchaseID" } })
                                @Html.ValidationMessageFor(model => model.Purchase_ID, "", new { @class = "text-danger" })

                            </div>
                            <div class="col-sm-6"></div>
                        </div>

                        <div class="row" style="margin-top:3px">
                            <div class="col-sm-2">Invoice DueDate:</div>
                            <div class="col-sm-4">

                                @Html.EditorFor(model => model.PurchaseDueDate, new { htmlAttributes = new { @class = "form-control", id = "PurchaseDueDate", title = "Due Date" } })
                                @Html.ValidationMessageFor(model => model.PurchaseDueDate, "", new { @class = "text-danger" })

                            </div>
                            <div class="col-sm-6"></div>
                        </div>


                        <div class="row" style="margin-top:3px">
                            <div class="col-sm-2">Refrence Number:</div>
                            <div class="col-sm-4">

                                @Html.EditorFor(Model => Model.PurchaseRefNumber, new { htmlAttributes = new { @class = "form-control", id = "PurchaseRefNumber" } })
                                @Html.ValidationMessageFor(model => model.PurchaseRefNumber, "", new { @class = "text-danger" })
                            </div>
                            <div class="col-sm-6"></div>
                        </div>

                        @*<div class="row" style="margin-top:3px">
                                <div class="col-sm-2">
                                    <a href="#"> Add Discount:</a>
                                </div>
                                <div class="col-sm-4">

                                    @Html.EditorFor(model => model.PurchaseDiscountAmount, new { htmlAttributes = new { @class = "form-control", id = "DiscountAmount" } })
                                    @Html.ValidationMessageFor(model => model.PurchaseDiscountAmount, "", new { @class = "text-danger" })
                                </div>
                                <div class="col-sm-6"></div>
                            </div>*@

                        @*<div class="row" style="margin-top:3px">
                                <div class="col-sm-2">
                                    <a href="#"> Add VAT:</a>
                                </div>
                                <div class="col-sm-4">
                                    @Html.EditorFor(model => model.PurchaseVatPercentage, new { htmlAttributes = new { @class = "form-control", id = "PurchaseVatPercentage" } })
                                    @Html.ValidationMessageFor(model => model.PurchaseVatPercentage, "", new { @class = "text-danger" })
                                </div>
                                <div class="col-sm-6"></div>
                            </div>*@

                        <div class="row">
                            <table class="table" id="orderdetailsitemsp">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>
                                            Product Name
                                        </th>
                                        <th>
                                            Quantity
                                        </th>
                                        <th>
                                            Price
                                        </th>
                                        <th>
                                            Total
                                        </th>
                                        <th>
                                            Vat
                                        </th>
                                        <th>
                                            Action
                                        </th>
                                        <th>

                                        </th>
                                        <th>

                                        </th>

                                    </tr>

                                    <tr id="mainrow">
                                        <td>
                                            <select id="SelectProductQutationp" class="productp form-control pClassp"></select>
                                        </td>
                                        <td>
                                            @Html.EditorFor(model => model.PurchaseQuantity, new { htmlAttributes = new { @type = "text", @class = "PurchaseQuantity form-control", id = "PurchaseQuantity" } })
                                            @Html.ValidationMessageFor(model => model.PurchaseQuantity, "", new { @class = "text-danger" })
                                        </td>
                                        <td>


                                            @Html.EditorFor(model => model.PurchaseItemRate, new { htmlAttributes = new { @class = "PurchaseItemRate form-control", id = "PurchaseItemRate" } })
                                            @Html.ValidationMessageFor(model => model.PurchaseItemRate, "", new { @class = "text-danger" })


                                        </td>
                                        <td>

                                            @Html.EditorFor(model => model.PurchaseTotal, new { htmlAttributes = new { @class = "PurchaseTotal form-control", id = "PurchaseTotal" } })
                                            @Html.ValidationMessageFor(model => model.PurchaseTotal, "", new { @class = "text-danger" })
                                        </td>
                                        <td>

                                            <select id="SelectVATp" class="VATp form-control" style="width:80px;">
                                                <option>0</option>
                                                <option>6</option>
                                                <option>21</option>
                                            </select>

                                        </td>
                                        <td>

                                            <input type="button" id="addpuchase" value="add" class="btn btn-success" style="width:80px" />

                                    </tr>
                                </thead>

                                <tbody>


                                    @if (ViewBag.PurchaseDatailsList != null)
                                    {
                                        foreach (var item in ViewBag.PurchaseDatailsList)
                                        {

                                            <tr id="@item.PurchaseOrderDetailsId">

                                                <td>

                                                    <select Id="SelectProductQutationp" class="productp form-control pClassp" style="width:216px !important">
                                                        <option value="0">Select Item..</option>
                                                        @foreach (var product in ViewBag.Product)
                                                        {
                                                            <option value="@product.ProductId" @(product.ProductId == item.PurchaseItemId ? "selected='selected'" : "")>@product.ProductName</option>
                                                        }
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" class="PurchaseQuantity form-control" id="Quantityp" value="@item.PurchaseQuantity" />
                                                </td>

                                                <td>
                                                    <input type="text" class="PurchaseItemRate  form-control" id="Ratep" value="@item.PurchaseItemRate" />
                                                </td>
                                                <td>
                                                    <input type="text" class="PurchaseTotal  form-control" id="FTotalp" value="@item.PurchaseTotal" readonly="readonly" />

                                                </td>
                                                <td>
                                                    <select id="SelectVATp" name="NewsCategoriesID" class="VATp  form-control" style="width:80px">

                                                        @foreach (var item1 in ViewBag.VatDrop)
                                                        {
                                                            <option value="@item1.Vat1" @(item1.Vat1 == item.PurchaseVatPercentage ? "selected='selected'" : "")>@item1.Name</option>
                                                        }
                                                    </select>

                                                </td>
                                                <td>
                                                    <button type="button" id="RemoveEdit" class="btn btn-danger">Remove</button>
                                                </td>
                                                <td>
                                                    <input type="hidden" class="PurchaseOrderDetailsId" value="@item.PurchaseOrderDetailsId" />

                                                </td>
                                                <td>
                                                    <input type="hidden" class="PurchaseOrderID" value="@item.PurchaseOrderID" />

                                                </td>


                                            </tr>
                                        }
                                    }



                                </tbody>

                            </table>
                        </div>
                        <div class="row">
                            <div id="OrderItems">
                                <table class="table" id="orderdetailsitemsp"></table>
                                <span id="orderItemError" style="color:red"></span>
                            </div>

                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-sm-8">
                            </div>
                            <div class="col-sm-2">Sub Total:</div>
                            <div class="col-sm-2">
                                <label id="SubTotalp">@Model.PurchaseSubTotal</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-8">
                            </div>
                            <div class="col-sm-2">Totaal excel BTW:</div>
                            <div class="col-sm-2">
                                <label id="TotalBTWp">@Model.PurchaseSubTotal</label>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-8">
                            </div>
                            <div class="col-sm-2">BTW0%:</div>
                            <div class="col-sm-2">
                                <label id="btwop">0.00</label>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-8">
                            </div>
                            <div class="col-sm-2">BTW 6%:</div>
                            <div class="col-sm-2">
                                <label id="BTW6p">@Model.Vat6</label>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-8">
                            </div>
                            <div class="col-sm-2">BTW 21%:</div>
                            <div class="col-sm-2">
                                <label id="BTW21p">@Model.Vat21</label>

                            </div>
                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-sm-2">Customer Note:</div>
                            <div class="col-sm-6">
                                @Html.TextAreaFor(model => model.PurchaseVenderNote, new { htmlAttributes = new { @class = "form-control", id = "PurchaseVenderNote" } })
                                @Html.ValidationMessageFor(model => model.PurchaseVenderNote, "", new { @class = "text-danger" })
                            </div>
                            <div class="col-sm-2">Grand Total:</div>
                            <div class="col-sm-2">
                                <span class=""><b>&euro;:</b></span>
                                <label id="gtotalp">@Model.PurchaseTotoalAmount</label>

                            </div>
                        </div>
                        <div class="row" style="margin-top:3px">
                            <div class="col-sm-2"></div>
                            <div class="col-sm-6">

                            </div>
                            <div class="col-sm-2"></div>
                            <div class="col-sm-2">

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-xs-2">
                                <input id="Submitp" type="button" value="Save draft" class="btn btn-primary" style="margin:0px 5px" />
                            </div>
                            <div class="col-xs-2">
                                <input id="saveEmailp" type="button" value="Save + email" class="btn btn-primary" style="margin:0px 5px" />
                            </div>
                            <div class="col-xs-3">
                                <input id="savesendbyemail" type="button" value="Save + send by email " class="btn btn-primary" style="margin:0px 5px" />
                            </div>
                            <div class="col-xs-3">
                                <input id="SaveEmailPrintPrintp" type="button" value="Save + print and send and send ot yourself" class="btn btn-primary" style="margin:0px 5px" />
                            </div>

                            <div class="col-sm-2"></div>
                            @*<div class="col-sm-1"></div>
                                <div class="col-sm-2"></div>
                                <div class="col-sm-2"></div>*@
                        </div>

                    </div>

                </div>
            </div>

        </div>
    </div>


</div>






<div class="modal fade bs-example-modal-lg" id="CreateNewProductModalAdd" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myLargeModalLabe1lPur" style="color:skyblue">Add New Product</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <form class="floating-labels">

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group m-b-40">
                                <input type="text" class="form-control " id="ProductName" data-toggle="tooltip" data-placement="bottom" title="Product Name!!">
                                <span class="bar"></span>
                                <label for="input5">Product Name</label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group m-b-40">
                                <input type="text" class="form-control " id="Description" data-toggle="tooltip" data-placement="bottom" title="Product Description!!">
                                <span class="bar"></span>
                                <label for="input5"> Product Description</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group m-b-40">
                                <input type="text" class="form-control " id="SalePrice" data-toggle="tooltip" data-placement="bottom" title="Sale Price!!">
                                <span class="bar"></span>
                                <label for="input5">Sale Price</label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group m-b-40">
                                <input type="text" class="form-control " id="PurchasePrice" data-toggle="tooltip" data-placement="bottom" title="Purchase Price!!">
                                <span class="bar"></span>
                                <label for="input5">Purchase Price</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group m-b-40">
                                <input type="text" class="form-control " id="OpeningQuantity" data-toggle="tooltip" data-placement="bottom" title="Opening Quantity!!">
                                <span class="bar"></span>
                                <label for="input5">Opening Quantity</label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group m-b-40">
                                <input type="text" class="form-control " id="AddedDate" data-toggle="tooltip" data-placement="bottom" title="Current Date!!">
                                <span class="bar"></span>
                                <label for="input5">Added Date</label>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="SaveNewProductModel" class="btn btn-success d-none d-lg-block m-l-15"><i class="fa fa-plus-circle"></i>Save Product</button>
                <button type="button" class="btn btn-danger waves-effect text-left" id="CancelProductModel" data-dismiss="modal">Close</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>




<script type="text/javascript">
    var currentRow1 = "";
    var r = "";

    function SUMOFALLPRODUCTp() {
        var sum = 0;
        $('#orderdetailsitemsp tbody tr').each(function () {
            var row = $(this).closest('tr');
            var total = row.find('td:eq(3)').find('.PurchaseTotal').val();
            if (!isNaN(total) && total.length != 0) {
                sum += parseFloat(total);
            }
            $('#TotalBTWp').text(sum.toFixed(2));
            $('#SubTotalp').text(sum.toFixed(2));
        })
    }
    function sumofGrandModelp() {

        var btw6p = 0, btw21p, totalbtwp = 0, grandtotalp = 0;
        btw6p = parseFloat($('#BTW6p').text());
        btw21p = parseFloat($('#BTW21p').text());
        totalbtwp = parseFloat($('#TotalBTWp').text());
        btw6p = isNaN(btw6p) ? 0 : btw6p;
        btw21p = isNaN(btw21p) ? 0 : btw21p;
        totalbtwp = isNaN(totalbtwp) ? 0 : totalbtwp;
        grandtotalp = parseFloat(btw6p) + parseFloat(btw21p) + parseFloat(totalbtwp);
        var t = parseFloat(grandtotalp);
        $('#gtotalp').text(t.toFixed(2));
        //
        //if (!isNaN(grandtotal) && grandtotal.length != 0) {
    }
    function calculatevatp() {
        if ($('#orderdetailsitemsp tr').length == 0) {
            $('#btwop').text('0.00');
            $('#BTW6p').text('0.00');
            $('#BTW21p').text('0.00');
        }
        else {

            var sum0 = 0;
            var total0 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                $('#BTW0p').text();

                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp   option:selected').val() == 0) {
                    total0 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total0) && total0.length != 0) {
                        sum0 += parseInt(total0);
                    }
                    var totalvat0 = parseFloat(sum0 / 100 * 6 + sum0 - sum0);
                    var totalr = Math.round(totalvat0, 2);
                    $('#BTW0p').text(totalvat0.toFixed(2));
                }
                else {
                    $('#BTW0p').text('0.00');
                }
            })
        }

        var sum6 = 0;
        var total6 = 0;
        $('#orderdetailsitemsp tbody tr').each(function () {
            var r = $(this).closest('tr');
            var value = r.find('.VATp   option:selected').val();
            if (r.find('.VATp   option:selected').val() == 6) {
                total6 = r.find('td:eq(3)').find('input').val();
                if (!isNaN(total6) && total6.length != 0) {
                    sum6 += parseInt(total6);
                }
                var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                var totalr = Math.round(totalvat6, 2);
                $('#BTW6p').text(totalvat6.toFixed(2));
            }
        })

        var sum21 = 0;
        var total21 = 0;
        $('#orderdetailsitemsp tbody  tr ').each(function () {
            //$('#BTW21').text();
            var r = $(this).closest('tr');
            var value = r.find('.VATp   option:selected').val();
            if (r.find('.VATp   option:selected').val() == 21) {

                total21 = r.find('td:eq(3)').find('input').val();
                if (!isNaN(total21) && total21.length != 0) {
                    sum21 += parseInt(total21);
                }
                var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);

                $('#BTW21p').text(totalvat21.toFixed(2));
            }

        })
        RowCountep();
    }
    function RowCountep() {

        var rowCount6 = 0;
        var rowCount21 = 0;
        var rowCount0 = 0;

        $('#orderdetailsitemsp tbody tr td').each(function () {


            var EquationResult = $(this).find('.VATp').val();

            if (EquationResult == 6) {
                rowCount6++;

            }
            else if (EquationResult == 21) {
                rowCount21++;
            }
            else if (EquationResult == 0) {
                rowCount0++
            }
        })

        if (rowCount0 == 0) {
            $("#btwop").text('0.00');
        }
        if (rowCount6 == 0) {
            $("#BTW6p").text('0.00');
        }
        if (rowCount21 == 0) {
            $("#BTW21p").text('0.00');
        }

        if ($('#orderdetailsitemsp tr').length == 0) {

            $('#SubTotalp').text();
            $('#TotalBTWp').text();
            $('#gtotalp').text();
        }
    }


    //adding Row
    $("#addpuchase").click(function () {

        currentRow1 = $(this).closest("tr");

        var isAllValid = true;
        if ($("#SelectProductQutationp").val() == "0") {
            isAllValid = false;
            alert("Please select Item");
        }

        if (isAllValid) {
            var $newRowp = $("#mainrow").clone().removeAttr('id');
            $('.productp', $newRowp).val($("#SelectProductQutationp").val());
            $('.VATp', $newRowp).val($("#SelectVATp").val());
            //Replace add button with remove button
            $("#addpuchase", $newRowp).addClass('remove').val('Remove').removeClass('btn-success').addClass('btn-danger');
            //Remove id attribute from new clone row
            $("#productp,#PurchaseQuantity,#Ratep,#FTotalp,#SelectVATp", $newRowp).removeAttr('id');
            $('span.error', $newRowp).remove();
            $('#orderdetailsitemsp').append($newRowp);

            $('thead #SelectProductQutationp').val('0');
            $('thead #PurchaseQuantity ').val('');
            $('thead #PurchaseItemRate ').val('');
            $('thead #PurchaseTotal ').val('');
            $('thead #VATp ').val('0');

            if ($('#orderItemError').text != '') {
                $('#orderItemError').text('');
            }
            calculatevatp();
            SUMOFALLPRODUCTp();
            sumofGrandModelp();


            $('#SelectVATp').val(0);
        }
    });
    //end of adding row
    $('#orderdetailsitemsp').on('click', '.remove', function () {

        debugger;

        var currentRow = $(this).closest('tr');
        var vat = currentRow.find('.VATp   option:selected').val();
        var Total = currentRow.find('.PurchaseTotal').val();
        if (vat == 6) {
            var totalvat6 = parseInt(Total / 100) * 6 + (Total - Total);

            var BTW6 = $('#BTW6p').text();
            $('#BTW6p').text();
            $('#BTW6p').text(parseInt(BTW6 - totalvat6.toFixed(2)));

        }
        if (vat == 21) {
            var currentRow = $(this).closest('tr');
            var vat21 = currentRow.find('.VATp  option:selected').val();
            var Total21 = currentRow.find('.PurchaseTotal').val();
            if (vat == 21) {
                var totalvat21 = parseFloat(Total21 / 100) * 21 + (Total21 - Total21);

                var BTW21 = $('#BTW21p').text();
                $('#BTW21p').text();
                $('#BTW21p').text(parseFloat(BTW21 - totalvat21.toFixed(2)));

            }
        }
        $(this).parents('tr').remove();
        SUMOFALLPRODUCTp();
        sumofGrandModelp();

        if ($('#orderdetailsitemsp tbody tr').length == 0) {
            $('#SubTotalp').text('0.0');
            $('#TotalBTWp').text('0.0');
            $('#gtotalp').text('0.0');
            $('#BTW6p').text('0.0');
            $('#BTW21p').text('0.0');
            $('#btwop').text('0.0');
            $('#SelectVATp').val(0);
        }
    });

    //main
    $('#PurchaseQuantity').keyup(function () {
        var currentRow = $(this).closest("tr");
        var quantity = $(this).val();  // get current row 1st TD value
        var Price = currentRow.find("td:eq(2)").find('input').val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
    })

    $(document).on('keyup', "#orderdetailsitemsp tbody .PurchaseQuantity", function () {
        debugger;
        var currentRow = $(this).closest("tr");
        var quantity = $(this).val();  // get current row 1st TD value
        var Price = currentRow.find("td:eq(2)").find('input').val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
    })

    $(document).on('keyup', "#orderdetailsitemsp tbody .PurchaseItemRate", function () {

        currentRow1 = $(this).closest("tr");
        var currentRow = $(this).closest("tr");
        var quantity = currentRow.find("td:eq(1)").find('input').val(); // get current row 1st TD value
        var Price = $(this).val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
        var sum = 0;
        var vatValue = currentRow1.find('.VATp option:selected').val();
        if (vatValue == 0) {
            $('#btwop').text('0.00');
        }

        if (vatValue == 6) {
            var sum6 = 0;
            var total6 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 6) {
                    total6 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total6) && total6.length != 0) {
                        sum6 += parseFloat(total6);
                    }
                    var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                    $('#BTW6p').text(totalvat6.toFixed(2));
                }
            })
        }

        if (vatValue == 21) {
            var sum21 = 0;
            var total21 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 21) {
                    total21 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total21) && total21.length != 0) {
                        sum21 += parseFloat(total21);
                    }
                    var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);
                    $('#BTW21p').text(totalvat21.toFixed(2));
                }

            })
        }
        SUMOFALLPRODUCTp();
        sumofGrandModelp();
    })

    $(document).on('keyup', "#orderdetailsitemsp tbody .PurchaseQuantity ", function () {
        currentRow1 = $(this).closest("tr");
        var currentRow = $(this).closest("tr");
        var quantity = $(this).val();  // get current row 1st TD value
        var Price = currentRow.find("td:eq(1)").find('input').val();
        var total = quantity * Price;
        currentRow.find('td:eq(3)').find('input').val(total);
        var sum = 0;
        var vatValue = currentRow1.find('.VATp option:selected').val();
        if (vatValue == 0) {
            $('#btwop').text('0.00');
        }

        if (vatValue == 6) {
            var sum6 = 0;
            var total6 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 6) {
                    total6 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total6) && total6.length != 0) {
                        sum6 += parseFloat(total6);
                    }
                    var totalvat6 = parseFloat(sum6 / 100 * 6 + sum6 - sum6);
                    $('#BTW6p').text(totalvat6.toFixed(2));
                }
            })


        }

        if (vatValue == 21) {
            var sum21 = 0;
            var total21 = 0;
            $('#orderdetailsitemsp tbody tr').each(function () {
                r = $(this).closest('tr');
                var value = r.find('.VATp  option:selected').val();
                if (r.find('.VATp  option:selected').val() == 21) {
                    total21 = r.find('td:eq(3)').find('input').val();
                    if (!isNaN(total21) && total21.length != 0) {
                        sum21 += parseFloat(total21);
                    }
                    var totalvat21 = parseFloat(sum21 / 100 * 21 + sum21 - sum21);
                    $('#BTW21p').text(totalvat21.toFixed(2));
                }

            })
        }


        SUMOFALLPRODUCTp();
        sumofGrandModelp();
    })

    $(document).on('change', '#orderdetailsitemsp tbody .VATp', function () {
        currentRow1 = $(this).closest("tr");
        calculatevatp();
        SUMOFALLPRODUCTp();
        sumofGrandModelp();
    });

    $(document).ready(function () {

        $("#SelectProductQutationp").find("option").remove();
        $("#SelectProductQutationp").prepend("<option value=0>" + 'Select Item' + "</option>");
        $("#SelectProductQutationp").append("<option value=AddNewProductSelect>" + 'Add New Product' + "</option>");

        $.ajax({
            url: "/MVCProduct/GetProduct",
            type: "Get",
            async: false,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                $.each(data, function (key, item) {
                    $('#SelectProductQutationp').append($('<option></option>').val(item.ProductId).html(item.ProductName));
                });
            },
            Error: function (errormessage) {
                alert(errormessage);
            }
        });
    });

    // product price by id
    $('thead .pClassp').change(function () {
        var productId = $(this).val();
        $.ajax({
            url: "/MVCQutation/ProductPricebyId",
            type: "POST",
            cache: false,
            data: { 'ProductId': productId },
            success: function (resultData) {
                $('thead #PurchaseItemRate ').val(resultData);
            },
            error: function (errormessage) {
                alert(errormessage)
            }
        });
    })
    //end

    //number validation
    $("thead.PurchaseQuantity").on("keypress keyup blur", function (event) {
        //this.value = this.value.replace(/[^0-9\.]/g,'');
        $(this).val($(this).val().replace(/[^0-9]/g, ''));
        if ((event.which != 46 || $(this).val().indexOf('.') != -1) && (event.which < 48 || event.which > 57)) {
            event.preventDefault();
        }
    });
    $("thead #PurchaseItemRate").on("keypress keyup blur", function (event) {
        //this.value = this.value.replace(/[^0-9\.]/g,'');
        $(this).val($(this).val().replace(/[^0-9\.]/g, ''));
        if ((event.which != 46 || $(this).val().indexOf('.') != -1) && (event.which < 48 || event.which > 57)) {
            event.preventDefault();
        }
    });
    //end of number validation


    //saving detail
    $("#Submitp").click(function () {
        var isAllValid = true;
        $('#orderItemError').text('');

        var list = [];
        var errorItemCount = 0;

        $('#orderdetailsitemsp > tbody > tr ').each(function (index, ele) {

            if ($('#SelectProductQutationp', this).val() == '0' ||
                (parseInt($('.PurchaseQuantity', this).val()) || 0) == 0 ||
                $('.ratep', this).val() == "" ||
                isNaN($('.PurchaseItemRate ', this).val())
                ) {
                errorItemCount++;
                $(this).addClass('error');
            }
            else {
                var orderItem = {
                    PurchaseItemId: $('select.productp', this).val(),
                    PurchaseQuantity: parseInt($('.PurchaseQuantity', this).val()),
                    PurchaseItemRate: parseFloat($('.PurchaseItemRate', this).val()),
                    PurchaseTotal: parseFloat($('.PurchaseTotal', this).val()),
                    Total: parseFloat($('.PurchaseTotal', this).val()),
                    PurchaseVatPercentage: parseFloat($('.VATp', this).val()),
                    PurchaseOrderDetailsId: $('.PurchaseOrderDetailsId', this).val(),
                    PurchaseOrderID: $('.PurchaseOrderID').val(),
                }
                list.push(orderItem);
            }
        });

        if (errorItemCount > 0) {
            $("#orderItemError").text(errorItemCount + "Invalid entry in order itme list.");
            isAllValid = false;
        }

        if (list.length == 0) {

            $("#orderItemError").text("At least one order item required.");
            isAllValid = false;
        }

        if (isAllValid) {

            $(this).val("please wait...");
            var empObj = {
                PurchaseId: $('#PurchaseId').val(),
                PurchaseID: $('#PurchaseID').val(),
                PurchaseRefNumber: $('#PurchaseRefNumber').val(),
                PurchaseDate: $('#PurchaseDate').val(),
                PurchaseDueDate: $('#PurchaseDueDate').val(),
                PurchaseSubTotal: $('#SubTotalp').text(),
                PurchaseDiscountAmount: $('#PurchaseDiscountAmount').val(),
                PurchaseOrderID: $('#PurchaseOrderID').val(),
                PurchaseTotoalAmount: $('#gtotalp').text(),
                PurchaseVenderNote: $('#PurchaseVenderNote').val(),
                Vat6: $('#BTW6p').text(),
                Vat21: $('#BTW21p').text(),
                //ConatctId: $('#contactId').val(),
                PurchaseDetailslist: list

            };
            $.ajax({
                url: "/Purchase/save",
                data: JSON.stringify(empObj),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {

                    if (result.Status == "Success") {                       
                        list = [];                      
                        $('#orderdetailsitems').empty();
                        $("#Submit").val('Save');
                        swal({
                            title: 'Invoice!',
                            text: 'Invoice save successfully!',
                            type: 'success'
                        },
                  function (isconform) {
                      window.location.href = "/Purchase/Viewinvoice?purchaseOrderId=" + result.purchaseId;
                  });
                    }
                    else if (result.Status == "Fail") {
                        alert(result.Message);
                    }
                },
                error: function (errormessage) {

                }

            });

        }

    });
    //saveing detail

    //Save Email
    $("#saveEmailp").click(function () {
        var isAllValid = true;
        $('#orderItemError').text('');

        var list = [];
        var errorItemCount = 0;

        $('#orderdetailsitemsp > tbody > tr ').each(function (index, ele) {

            if ($('#SelectProductQutationp', this).val() == '0' ||
                (parseInt($('.PurchaseQuantity', this).val()) || 0) == 0 ||
                $('.ratep', this).val() == "" ||
                isNaN($('.PurchaseItemRate ', this).val())
                ) {
                errorItemCount++;
                $(this).addClass('error');
            }
            else {
                var orderItem = {
                    PurchaseItemId: $('select.productp', this).val(),
                    PurchaseQuantity: parseInt($('.PurchaseQuantity', this).val()),
                    PurchaseItemRate: parseFloat($('.PurchaseItemRate', this).val()),
                    PurchaseTotal: parseFloat($('.PurchaseTotal', this).val()),
                    Total: parseFloat($('.PurchaseTotal', this).val()),
                    PurchaseVatPercentage: parseFloat($('.VATp', this).val()),
                    PurchaseOrderDetailsId: $('.PurchaseOrderDetailsId', this).val(),
                    PurchaseOrderID: $('.PurchaseOrderID').val(),
                }
                list.push(orderItem);
            }
        });

        if (errorItemCount > 0) {
            $("#orderItemError").text(errorItemCount + "Invalid entry in order itme list.");
            isAllValid = false;
        }

        if (list.length == 0) {

            $("#orderItemError").text("At least one order item required.");
            isAllValid = false;
        }

        if (isAllValid) {

            $(this).val("please wait...");
            var empObj = {
                PurchaseId: $('#PurchaseId').val(),
                PurchaseID: $('#PurchaseID').val(),
                PurchaseRefNumber: $('#PurchaseRefNumber').val(),
                PurchaseDate: $('#PurchaseDate').val(),
                PurchaseDueDate: $('#PurchaseDueDate').val(),
                PurchaseSubTotal: $('#SubTotalp').text(),
                PurchaseDiscountAmount: $('#PurchaseDiscountAmount').val(),
                PurchaseOrderID: $('#PurchaseOrderID').val(),
                PurchaseTotoalAmount: $('#gtotalp').text(),
                PurchaseVenderNote: $('#PurchaseVenderNote').val(),
                Vat6: $('#BTW6p').text(),
                Vat21: $('#BTW21p').text(),
                //ConatctId: $('#contactId').val(),
                PurchaseDetailslist: list

            };
            $.ajax({
                url: "/Purchase/saveEmail",
                data: JSON.stringify(empObj),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {

                    if (result.Status == "Success") {
                        alert('eddw');

                        $("#Submitp").val('Save Draft');
                        list = [];

                    }
                    else if (result.Status == "Fail") {
                    }
                },
                error: function (errormessage) {

                }

            });

        }

    });

    //End save and Email

    //save print
    $("#SaveEmailPrintPrintp").click(function () {
        var isAllValid = true;
        $('#orderItemError').text('');

        var list = [];
        var errorItemCount = 0;

        $('#orderdetailsitemsp > tbody > tr ').each(function (index, ele) {

            if ($('#SelectProductQutationp', this).val() == '0' ||
                (parseInt($('.PurchaseQuantity', this).val()) || 0) == 0 ||
                $('.ratep', this).val() == "" ||
                isNaN($('.PurchaseItemRate ', this).val())
                ) {
                errorItemCount++;
                $(this).addClass('error');
            }
            else {
                var orderItem = {
                    PurchaseItemId: $('select.productp', this).val(),
                    PurchaseQuantity: parseInt($('.PurchaseQuantity', this).val()),
                    PurchaseItemRate: parseFloat($('.PurchaseItemRate', this).val()),
                    PurchaseTotal: parseFloat($('.PurchaseTotal', this).val()),
                    Total: parseFloat($('.PurchaseTotal', this).val()),
                    PurchaseVatPercentage: parseFloat($('.VATp', this).val()),
                    PurchaseOrderDetailsId: $('.PurchaseOrderDetailsId', this).val(),
                    PurchaseOrderID: $('.PurchaseOrderID').val(),
                }
                list.push(orderItem);
            }
        });

        if (errorItemCount > 0) {
            $("#orderItemError").text(errorItemCount + "Invalid entry in order itme list.");
            isAllValid = false;
        }

        if (list.length == 0) {

            $("#orderItemError").text("At least one order item required.");
            isAllValid = false;
        }

        if (isAllValid) {

            $(this).val("please wait...");
            var empObj = {
                PurchaseId: $('#PurchaseId').val(),
                PurchaseID: $('#PurchaseID').val(),
                PurchaseRefNumber: $('#PurchaseRefNumber').val(),
                PurchaseDate: $('#PurchaseDate').val(),
                PurchaseDueDate: $('#PurchaseDueDate').val(),
                PurchaseSubTotal: $('#SubTotalp').text(),
                PurchaseDiscountAmount: $('#PurchaseDiscountAmount').val(),
                PurchaseOrderID: $('#PurchaseOrderID').val(),
                PurchaseTotoalAmount: $('#gtotalp').text(),
                PurchaseVenderNote: $('#PurchaseVenderNote').val(),
                Vat6: $('#BTW6p').text(),
                Vat21: $('#BTW21p').text(),
                //ConatctId: $('#contactId').val(),
                PurchaseDetailslist: list

            };
            $.ajax({
                url: "/Purchase/saveEmailPrint",
                data: JSON.stringify(empObj),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    if (result.Status == "Success") {
                        $("#Submitp").val('Save Draft');
                        list = [];
                    }
                    else if (result.Status == "Fail") {

                    }
                },
                error: function (errormessage) {

                }

            });

        }

    });


</script>